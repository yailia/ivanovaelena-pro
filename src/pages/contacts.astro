---
import Layout from '../components/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// URL воркера на Render
const WORKER_URL = 'https://ivanovaelena-pro.onrender.com';
---

<Layout title="Контакты - Психолог Лена" description="Свяжитесь со мной: Telegram, WhatsApp, Email">
	<Header />
	<main>
		<section class="section">
			<div class="container">
				<h1>Контакты</h1>
				
				<div class="contacts-grid">
					<div class="contacts-info">
						<h2>Свяжитесь со мной</h2>
						<ul class="contacts-list">
							<li>
								<strong>Telegram:</strong>
								<a href="https://t.me/" target="_blank" rel="noopener">@username</a>
							</li>
							<li>
								<strong>WhatsApp:</strong>
								<a href="https://wa.me/" target="_blank" rel="noopener">+7 (XXX) XXX-XX-XX</a>
							</li>
							<li>
								<strong>Email:</strong>
								<a href="mailto:">email@example.com</a>
							</li>
						</ul>
					</div>

					<div class="contacts-form">
						<h2>Форма записи</h2>
						<form id="contact-form" class="form" data-worker-url={WORKER_URL}>
							<div class="form-group">
								<label for="name">Имя</label>
								<input type="text" id="name" name="name" required minlength="2" placeholder=" " />
							</div>
							
							<div class="form-group">
								<label>Предпочитаемый способ связи</label>
								<div class="contact-method-options">
									<label class="contact-method-option">
										<input type="radio" name="contactMethod" value="telegram" checked />
										<span>Телеграм</span>
									</label>
									<label class="contact-method-option">
										<input type="radio" name="contactMethod" value="max" />
										<span>Max</span>
									</label>
									<label class="contact-method-option">
										<input type="radio" name="contactMethod" value="phone" />
										<span>Телефон</span>
									</label>
									<label class="contact-method-option">
										<input type="radio" name="contactMethod" value="email" />
										<span>Email</span>
									</label>
								</div>
							</div>

							<div class="form-group contact-input-group" id="contact-input-telegram">
								<label for="contact-telegram">Ваш Телеграм</label>
								<input type="text" id="contact-telegram" name="telegram" required placeholder="@username" />
							</div>
							
							<div class="form-group contact-input-group" id="contact-input-max" style="display: none;">
								<label for="contact-max">Ваш Max</label>
								<input type="text" id="contact-max" name="max" placeholder="@username или номер" />
							</div>
							
							<div class="form-group contact-input-group" id="contact-input-phone" style="display: none;">
								<label for="contact-phone">Ваш телефон</label>
								<input type="tel" id="contact-phone" name="phone" placeholder="+7 (___) ___-__-__" />
							</div>
							
							<div class="form-group contact-input-group" id="contact-input-email" style="display: none;">
								<label for="contact-email">Ваш Email</label>
								<input type="email" id="contact-email" name="email" placeholder=" " />
							</div>

							<div class="form-group">
								<label for="message">Сообщение</label>
								<textarea id="message" name="message" rows="5" maxlength="2000" placeholder=" "></textarea>
							</div>
							
							<!-- Статус отправки -->
							<div id="form-status" class="form-status" aria-live="polite"></div>
							
							<button type="submit" id="submit-btn" class="btn">
								<span class="btn-text">Отправить</span>
								<span class="btn-loader" aria-hidden="true"></span>
							</button>
						</form>
					</div>
				</div>

				<div class="contacts-notice">
					<h3>Важная информация</h3>
					<ul>
						<li><strong>Отмена:</strong> Пожалуйста, отменяйте запись не менее чем за 24 часа.</li>
						<li><strong>Конфиденциальность:</strong> Все данные строго конфиденциальны.</li>
					</ul>
				</div>
			</div>
		</section>
	</main>
	<Footer />
</Layout>

<script>
	const form = document.getElementById('contact-form') as HTMLFormElement;
	const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
	const statusEl = document.getElementById('form-status') as HTMLDivElement;
	const workerUrl = form?.dataset.workerUrl;

	// Переключение способа связи
	const contactMethodRadios = document.querySelectorAll('input[name="contactMethod"]');
	const contactInputGroups = document.querySelectorAll('.contact-input-group');

	function switchContactMethod(method: string) {
		contactInputGroups.forEach((group) => {
			const input = group.querySelector('input') as HTMLInputElement;
			if (group.id === `contact-input-${method}`) {
				(group as HTMLElement).style.display = 'flex';
				input.required = true;
			} else {
				(group as HTMLElement).style.display = 'none';
				input.required = false;
				input.value = '';
			}
		});
	}

	contactMethodRadios.forEach((radio) => {
		radio.addEventListener('change', (e) => {
			const target = e.target as HTMLInputElement;
			switchContactMethod(target.value);
		});
	});

	function setStatus(type: 'success' | 'error' | 'loading' | '', message: string) {
		statusEl.className = `form-status ${type ? `form-status--${type}` : ''}`;
		statusEl.textContent = message;
	}

	function setLoading(loading: boolean) {
		submitBtn.disabled = loading;
		submitBtn.classList.toggle('btn--loading', loading);
		if (loading) {
			setStatus('loading', 'Отправка...');
		}
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		
		if (!workerUrl) {
			setStatus('error', 'Ошибка конфигурации. Попробуйте позже.');
			return;
		}

		setLoading(true);

		const formData = new FormData(form);
		const contactMethod = formData.get('contactMethod') as string;
		
		// Собираем контактные данные в зависимости от выбранного способа
		let contactValue = '';
		if (contactMethod === 'telegram') contactValue = formData.get('telegram') as string;
		else if (contactMethod === 'max') contactValue = formData.get('max') as string;
		else if (contactMethod === 'phone') contactValue = formData.get('phone') as string;
		else if (contactMethod === 'email') contactValue = formData.get('email') as string;

		const data = {
			name: formData.get('name'),
			contactMethod: contactMethod,
			contact: contactValue,
			message: formData.get('message')
		};

		try {
			const response = await fetch(`${workerUrl}/api/submit`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			});

			const result = await response.json();

			if (response.ok && result.success) {
				setStatus('success', 'Заявка отправлена! Я свяжусь с вами в ближайшее время.');
				form.reset();
				switchContactMethod('telegram'); // Сброс к дефолтному
			} else if (response.status === 429) {
				setStatus('error', 'Слишком много запросов. Попробуйте через минуту.');
			} else {
				const errorMsg = result.errors?.join(', ') || result.error || 'Ошибка отправки';
				setStatus('error', errorMsg);
			}
		} catch (error) {
			console.error('Form submission error:', error);
			setStatus('error', 'Не удалось отправить заявку. Проверьте интернет-соединение.');
		} finally {
			setLoading(false);
		}
	});
</script>

<style>
	.contacts-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 3rem;
		margin-top: 3rem;
	}

	.contacts-list {
		list-style: none;
		padding: 0;
		margin: 2rem 0;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.contacts-list li {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.contacts-list a {
		color: var(--color-accent);
		text-decoration: none;
	}

	.contacts-list a:hover {
		text-decoration: underline;
	}

	.form {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		margin-top: 2rem;
	}

	.form-group {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.form-group label {
		font-weight: 500;
		color: var(--color-text-primary);
	}

	.form-group input,
	.form-group textarea {
		padding: 0.75rem;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-button);
		font-size: var(--font-size-body);
		font-family: inherit;
		transition: border-color 0.2s ease;
	}

	.form-group input:focus,
	.form-group textarea:focus {
		outline: none;
		border-color: var(--color-accent);
		box-shadow: 0 0 0 3px rgba(58, 141, 255, 0.15);
	}

	.form-group input:invalid:not(:placeholder-shown),
	.form-group textarea:invalid:not(:placeholder-shown) {
		border-color: var(--color-error);
	}

	/* Способ связи */
	.contact-method-options {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem;
	}

	.contact-method-option {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.625rem 1rem;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-button);
		cursor: pointer;
		transition: all 0.2s ease;
		font-weight: 400;
	}

	.contact-method-option:hover {
		border-color: var(--color-primary);
		background: rgba(111, 216, 197, 0.05);
	}

	.contact-method-option:has(input:checked) {
		border-color: var(--color-primary);
		background: rgba(111, 216, 197, 0.15);
	}

	.contact-method-option input[type="radio"] {
		width: 1rem;
		height: 1rem;
		accent-color: var(--color-primary);
		margin: 0;
	}

	.contact-input-group {
		display: flex;
	}

	/* Статус отправки */
	.form-status {
		padding: 0;
		border-radius: var(--radius-button);
		font-size: 0.9375rem;
		min-height: 0;
		transition: all 0.2s ease;
	}

	.form-status:not(:empty) {
		padding: 0.875rem 1rem;
		min-height: auto;
	}

	.form-status--success {
		background-color: rgba(58, 191, 124, 0.1);
		color: var(--color-success);
		border: 1px solid var(--color-success);
	}

	.form-status--error {
		background-color: rgba(231, 98, 95, 0.1);
		color: var(--color-error);
		border: 1px solid var(--color-error);
	}

	.form-status--loading {
		background-color: rgba(58, 141, 255, 0.1);
		color: var(--color-accent);
		border: 1px solid var(--color-accent);
	}

	/* Кнопка с лоадером */
	.btn {
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
	}

	.btn-loader {
		display: none;
		width: 1rem;
		height: 1rem;
		border: 2px solid transparent;
		border-top-color: currentColor;
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	.btn--loading .btn-text {
		opacity: 0.7;
	}

	.btn--loading .btn-loader {
		display: block;
	}

	.btn:disabled {
		opacity: 0.7;
		cursor: not-allowed;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	.contacts-notice {
		margin-top: 3rem;
		padding: 2rem;
		background: var(--color-bg-primary);
		border-radius: var(--radius-card);
	}

	.contacts-notice h3 {
		margin: 0;
	}

	.contacts-notice ul {
		margin-top: 1rem;
		padding-left: 1.5rem;
	}

	.contacts-notice li {
		margin-bottom: 0.75rem;
	}

	@media (max-width: 768px) {
		.contacts-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
