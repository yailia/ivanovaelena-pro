---
import Layout from "../components/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Hero from "../components/Hero.astro";
import TargetAudience from "../components/TargetAudience.astro";
import Problems from "../components/Problems.astro";
import HowIWork from "../components/HowIWork.astro";
// import SocialProof from "../components/SocialProof.astro";
// import Offer from "../components/Offer.astro";
import Services from "../components/Services.astro";
import AnxietyPreview from "../components/AnxietyPreview.astro";
import AboutMe from "../components/AboutMe.astro";
import FAQ from "../components/FAQ.astro";
import FinalCTA from "../components/FinalCTA.astro";
import SchemaOrg from "../components/seo/SchemaOrg.astro";
import { getCollection } from 'astro:content';
import { entryToBlogPost } from '../utils/content';
import { formatDate } from '../utils/date';

const siteUrl = 'https://ivanovaelena.pro';

// Получаем последние статьи для главной
const blogEntries = await getCollection('blog');
const latestPosts = blogEntries
	.map(entryToBlogPost)
	.sort((a, b) => b.date.getTime() - a.date.getTime())
	.slice(0, 3);
---

<Layout 
  title="Психолог онлайн — КПТ терапия тревоги | Елена Иванова"
  description="Психолог Елена Иванова. Помогаю справиться с тревогой, стрессом и эмоциональным выгоранием методами КПТ. Онлайн консультации. Первая сессия бесплатно."
  ogImage="/og-default.png"
>
  <link slot="head" rel="preload" as="image" href="/images/hero-photo.webp" fetchpriority="high" />
  <!-- Schema.org Organization -->
  <SchemaOrg schema={{
    type: 'Organization',
    name: 'Психолог Елена Иванова',
    description: 'Психолог, работаю с тревогой и стрессом методами КПТ. Онлайн консультации.',
    url: siteUrl,
    serviceType: ['Психологическое консультирование', 'Когнитивно-поведенческая терапия', 'Работа с тревогой', 'Коучинг'],
  }} />
  
  <!-- Schema.org FAQ -->
  <SchemaOrg schema={{
    type: 'FAQ',
    questions: [
      { question: 'Сколько длится консультация?', answer: 'Консультация длится 50-60 минут.' },
      { question: 'Можно ли работать онлайн?', answer: 'Да, я провожу консультации онлайн через Zoom или Telegram.' },
      { question: 'Сколько сессий нужно для результата?', answer: 'В среднем для работы с тревогой требуется 8-12 сессий КПТ.' },
    ],
  }} />

  <Header />
  <main>
    <Hero />
    <TargetAudience />
    <Problems />
    <HowIWork />
    {/* <SocialProof /> */}
    {/* <Offer /> */}
    <AboutMe />
    
    <!-- Быстрые тесты -->
    <section class="tests-preview-section">
      <div class="container">
        <h2 class="section-title">Быстрые тесты</h2>
        <p class="section-subtitle">
          Короткие опросники для аккуратного самонаблюдения. Они не ставят диагноз, а помогают заметить динамику состояний.
        </p>
        <div class="tests-preview-grid">
          <a href="/tests" class="test-preview-card test-preview-card--all">
            <h3>Все тесты</h3>
            <p>Посмотреть все доступные тесты</p>
          </a>
          <a href="/tests/gad-7" class="test-preview-card">
            <h3>GAD‑7</h3>
            <p>Уровень тревоги</p>
          </a>
          <a href="/tests/phq-9" class="test-preview-card">
            <h3>PHQ‑9</h3>
            <p>Уровень депрессии</p>
          </a>
          <a href="/tests/hads" class="test-preview-card">
            <h3>HADS</h3>
            <p>Тревога и депрессия</p>
          </a>
        </div>
      </div>
    </section>

    <Services />
    
    <AnxietyPreview />
    
    <!-- Последние статьи -->
    {latestPosts.length > 0 && (
      <section class="blog-preview-section">
        <div class="container">
          <div class="blog-preview-header">
            <h2 class="section-title">Последние статьи</h2>
            <p class="section-subtitle">
              Практики, техники и наблюдения, которые помогают проживать тревогу и выстраивать устойчивую жизнь.
            </p>
            <a href="/blog" class="blog-preview-link">Все статьи →</a>
          </div>
          <div class="blog-preview-grid">
            {latestPosts.map((post) => (
              <article class="blog-preview-card">
                <div class="blog-preview-content">
                  <div class="blog-preview-meta">
                    <time>{formatDate(post.date)}</time>
                    <span>·</span>
                    <span>{post.readingTime} мин</span>
                  </div>
                  <h3>
                    <a href={`/blog/${post.id}`}>{post.title}</a>
                  </h3>
                  <p class="blog-preview-excerpt">{post.excerpt}</p>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>
    )}
    
    <FAQ />
    
    <FinalCTA />
  </main>
  <Footer />
</Layout>

<style>
  /* Быстрые тесты */
  .tests-preview-section {
    padding: var(--spacing-section) 0;
    background-color: white;
  }

  .tests-preview-section .section-title {
    font-size: var(--font-size-h2);
    font-weight: 500;
    color: var(--color-text-primary);
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .tests-preview-section .section-subtitle {
    font-size: var(--font-size-body);
    color: var(--color-text-secondary);
    text-align: center;
    margin: 0 0 3rem 0;
  }

  .tests-preview-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .test-preview-card {
    padding: 1.5rem;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-card);
    text-decoration: none;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .test-preview-card:hover {
    border-color: var(--color-primary);
    background: rgba(111, 216, 197, 0.08);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(31, 42, 46, 0.06);
  }

  .test-preview-card--all {
    border-color: var(--color-primary);
    border-width: 2px;
    background: rgba(111, 216, 197, 0.05);
  }

  .test-preview-card h3 {
    font-size: var(--font-size-h3);
    font-weight: 500;
    color: var(--color-text-primary);
    margin: 0;
  }

  .test-preview-card p {
    font-size: var(--font-size-caption);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.5;
  }

  /* Последние статьи */
  .blog-preview-section {
    padding: var(--spacing-section) 0;
    background-color: var(--color-bg-primary);
  }

  .blog-preview-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .blog-preview-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: var(--font-size-body);
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
  }

  .blog-preview-link:hover {
    color: var(--color-primary);
  }

  .blog-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .blog-preview-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-card);
    overflow: hidden;
    transition: all 0.2s ease;
  }

  .blog-preview-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 8px 24px rgba(31, 42, 46, 0.08);
    transform: translateY(-2px);
  }

  .blog-preview-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .blog-preview-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--font-size-caption);
    color: var(--color-text-secondary);
  }

  .blog-preview-card h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .blog-preview-card h3 a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .blog-preview-card:hover h3 a {
    color: var(--color-accent);
  }

  .blog-preview-excerpt {
    font-size: var(--font-size-body);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 1024px) {
    .tests-preview-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .tests-preview-grid {
      grid-template-columns: 1fr;
    }

    .blog-preview-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .blog-preview-content {
      padding: 1.25rem;
    }
  }

</style>
